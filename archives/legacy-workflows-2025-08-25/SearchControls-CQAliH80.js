const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["leaflet-src-DpNb-JC5.js","index-Lw-5Bnhn.js","index-k9fKsC9O.css","index-CccW_ddn.js"])))=>i.map(i=>d[i]);
var ue=Object.defineProperty,me=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var Z=Object.getOwnPropertySymbols;var ee=Object.prototype.hasOwnProperty,te=Object.prototype.propertyIsEnumerable;var X=(s,o,a)=>o in s?ue(s,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[o]=a,F=(s,o)=>{for(var a in o||(o={}))ee.call(o,a)&&X(s,a,o[a]);if(Z)for(var a of Z(o))te.call(o,a)&&X(s,a,o[a]);return s},z=(s,o)=>me(s,he(o));var se=(s,o)=>{var a={};for(var i in s)ee.call(s,i)&&o.indexOf(i)<0&&(a[i]=s[i]);if(s!=null&&Z)for(var i of Z(s))o.indexOf(i)<0&&te.call(s,i)&&(a[i]=s[i]);return a};var B=(s,o,a)=>new Promise((i,r)=>{var S=u=>{try{h(a.next(u))}catch(m){r(m)}},R=u=>{try{h(a.throw(u))}catch(m){r(m)}},h=u=>u.done?i(u.value):Promise.resolve(u.value).then(S,R);h((a=a.apply(s,o)).next())});import{ao as G,r as l,j as e,L as pe,A as re,B as E,_ as O,a as xe,u as fe,p as ae,C as oe,t as Y,b,F as L,y as Q,ap as ne,E as C}from"./index-Lw-5Bnhn.js";import{f as ie,g as ge}from"./geocoding-Lee6uqsg.js";import{R as V}from"./Row-DRjBf6u9.js";const N={LOADING:"loading",READY:"ready",ERROR:"error",FALLBACK:"fallback"},je=()=>{try{return O(()=>import("./leaflet-src-DpNb-JC5.js").then(s=>s.l),__vite__mapDeps([0,1,2])).then(s=>{const o=s.default||s;return delete o.Icon.Default.prototype._getIconUrl,o.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"}),o})}catch(s){return console.warn("Failed to setup Leaflet icons:",s),null}},ye=()=>B(null,null,function*(){try{const s=yield O(()=>import("./index-CccW_ddn.js"),__vite__mapDeps([3,1,2,0]));return{MapContainer:s.MapContainer,TileLayer:s.TileLayer,Marker:s.Marker,Popup:s.Popup,Circle:s.Circle}}catch(s){throw console.error("Failed to load React Leaflet components:",s),s}}),be=h=>{var u=h,{center:s=[40.7128,-74.006],zoom:o=11,style:a={height:"400px",width:"100%"},className:i="",children:r,onMapReady:S}=u,R=se(u,["center","zoom","style","className","children","onMapReady"]);const[m,p]=l.useState(N.LOADING),[k,w]=l.useState(null),[x,I]=l.useState(null),[T,P]=l.useState(null),[g,U]=l.useState(0),D=l.useRef(null),v=3,A=l.useMemo(()=>Array.isArray(s)&&s.length===2&&typeof s[0]=="number"&&typeof s[1]=="number"?s:(console.warn("Invalid map center provided, using default"),[40.7128,-74.006]),[s]);l.useEffect(()=>{let y=!0;return B(null,null,function*(){try{p(N.LOADING),w(null),console.log("üó∫Ô∏è Initializing map libraries...");const M=yield je();if(!y)return;if(!M)throw new Error("Failed to load Leaflet library");I(M),console.log("‚úÖ Leaflet loaded successfully");const $=yield ye();if(!y)return;P($),console.log("‚úÖ React Leaflet components loaded successfully"),yield new Promise(W=>setTimeout(W,100)),y&&(p(N.READY),console.log("üó∫Ô∏è Map loaded successfully"),S&&S())}catch(M){console.error("‚ùå Map initialization failed:",M),y&&(w(M.message),g<v?(console.log("üîÑ Retrying map initialization... (".concat(g+1,"/").concat(v,")")),setTimeout(()=>{U($=>$+1)},1e3*(g+1))):p(N.ERROR))}}),()=>{y=!1}},[g,S,v]);const _=()=>{U(0),p(N.LOADING),w(null)},j=()=>{p(N.FALLBACK)};if(m===N.LOADING)return e.jsxs("div",{className:"d-flex flex-column justify-content-center align-items-center border rounded ".concat(i),style:a,children:[e.jsx(pe,{animation:"border",variant:"primary",className:"mb-3"}),e.jsxs("div",{className:"text-center",children:[e.jsx("h6",{className:"mb-1",children:"Loading Interactive Map..."}),e.jsx("small",{className:"text-muted",children:g>0&&"Retry attempt ".concat(g,"/").concat(v)})]})]});if(m===N.ERROR)return e.jsxs(re,{variant:"warning",className:i,style:a,children:[e.jsx(re.Heading,{children:"Map Unavailable"}),e.jsx("p",{children:"We're having trouble loading the interactive map component."}),k&&e.jsx("div",{className:"alert alert-light mb-3",children:e.jsxs("small",{className:"text-muted",children:["Technical details: ",k]})}),e.jsxs("div",{className:"d-flex gap-2",children:[e.jsx(E,{variant:"outline-warning",size:"sm",onClick:_,children:"üîÑ Try Again"}),e.jsx(E,{variant:"outline-secondary",size:"sm",onClick:j,children:"üìç Use Simple View"})]})]});if(m===N.FALLBACK)return e.jsx("div",{className:"d-flex flex-column justify-content-center align-items-center border rounded bg-light ".concat(i),style:a,children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("h5",{className:"mb-3",children:"üìç Location Information"}),e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Latitude:"})," ",A[0].toFixed(4),e.jsx("br",{}),e.jsx("strong",{children:"Longitude:"})," ",A[1].toFixed(4)]}),e.jsx("small",{className:"text-muted d-block mb-3",children:"Interactive map is not available, but location coordinates are shown above."}),e.jsx(E,{variant:"outline-primary",size:"sm",onClick:_,children:"üó∫Ô∏è Try Loading Interactive Map"})]})});if(m===N.READY&&T){const{MapContainer:y,TileLayer:H,Marker:M,Popup:$,Circle:W}=T;return e.jsx("div",{className:"map-wrapper ".concat(i),style:{position:"relative"},children:e.jsxs(y,z(F({ref:D,center:A,zoom:o,style:a,className:"map-container"},R),{children:[e.jsx(H,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',errorTileUrl:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMjU2IiBoZWlnaHQ9IjI1NiIgZmlsbD0iI2Y4ZjlmYSIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM2Yzc1N2QiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+TWFwIFRpbGUgVW5hdmFpbGFibGU8L3RleHQ+PC9zdmc+"}),r]}))})}return e.jsx("div",{className:"d-flex justify-content-center align-items-center border rounded ".concat(i),style:a,children:e.jsx("div",{className:"text-center text-muted",children:e.jsx("p",{children:"Map component is loading..."})})})},ce=G.forwardRef((s,o)=>{const[a,i]=l.useState(null);return l.useEffect(()=>{O(()=>import("./index-CccW_ddn.js"),__vite__mapDeps([3,1,2,0])).then(r=>{i(()=>r.Marker)}).catch(console.error)},[]),a?G.createElement(a,z(F({},s),{ref:o})):null}),le=G.forwardRef((s,o)=>{const[a,i]=l.useState(null);return l.useEffect(()=>{O(()=>import("./index-CccW_ddn.js"),__vite__mapDeps([3,1,2,0])).then(r=>{i(()=>r.Popup)}).catch(console.error)},[]),a?G.createElement(a,z(F({},s),{ref:o})):null}),Le=G.forwardRef((s,o)=>{const[a,i]=l.useState(null);return l.useEffect(()=>{O(()=>import("./index-CccW_ddn.js"),__vite__mapDeps([3,1,2,0])).then(r=>{i(()=>r.Circle)}).catch(console.error)},[]),a?G.createElement(a,z(F({},s),{ref:o})):null}),q=({listing:s,cityCache:o,setCityCache:a})=>{const[i,r]=l.useState("Calculating...");return l.useEffect(()=>{B(null,null,function*(){var R,h;try{if(!s){r("Unknown location");return}if(typeof s.distance=="number"&&s.distance>=0){const u="".concat((s.distance*.621371).toFixed(1),"mi");if(!((R=s.user)!=null&&R.latitude)||!((h=s.user)!=null&&h.longitude)){r(u);return}const m="".concat(s.user.latitude.toFixed(3),",").concat(s.user.longitude.toFixed(3));if(o.has(m)){const p=o.get(m);r(ie(s.distance,p));return}try{const p=yield ge(s.user.latitude,s.user.longitude);a(k=>new Map(k).set(m,p)),r(ie(s.distance,p))}catch(p){console.warn("Error getting city name, using distance only:",p),r(u)}}else r("Location unknown")}catch(u){console.error("Error in LocationDisplay:",u),r("Location error")}})},[s,o,a]),e.jsx("span",{children:i})},Se=()=>{const s=xe(),o=fe(),{searchResults:a,loading:i}=ae(t=>t.listings),{currentUser:r}=ae(t=>t.user),[S,R]=l.useState(null),[h,u]=l.useState(10),[m,p]=l.useState(""),[k,w]=l.useState([40.7128,-74.006]),[x,I]=l.useState(null),[T,P]=l.useState(null),[g,U]=l.useState(""),[D,v]=l.useState(!1),[A,_]=l.useState(new Map),[j,y]=l.useState("unknown");if(l.useEffect(()=>{const t=n=>{console.error("üí• SearchControls component error:",n),R(n.message||"An unexpected error occurred")};return window.addEventListener("error",t),window.addEventListener("unhandledrejection",n=>{t(new Error(n.reason))}),()=>{window.removeEventListener("error",t),window.removeEventListener("unhandledrejection",t)}},[]),l.useEffect(()=>{r!=null&&r.latitude&&(r!=null&&r.longitude)&&!x&&(w([r.latitude,r.longitude]),I([r.latitude,r.longitude])),H()},[r,x]),S)return e.jsx(oe,{fluid:!0,className:"py-4",children:e.jsx(V,{children:e.jsx(Y,{children:e.jsx(b,{children:e.jsxs(b.Body,{className:"text-center",children:[e.jsx("h5",{className:"text-danger",children:"‚ö†Ô∏è Something went wrong"}),e.jsx("p",{className:"text-muted mb-3",children:"We encountered an unexpected error with the map search functionality."}),e.jsx("div",{className:"alert alert-light",children:e.jsxs("small",{className:"text-muted",children:["Error: ",S]})}),e.jsx(E,{variant:"primary",onClick:()=>{R(null),window.location.reload()},children:"üîÑ Refresh Page"}),e.jsx(E,{variant:"outline-secondary",className:"ms-2",onClick:()=>o("/"),children:"üè† Go to Marketplace"})]})})})})});const H=()=>B(null,null,function*(){if(!navigator.permissions||!navigator.geolocation){y("unsupported");return}try{const t=yield navigator.permissions.query({name:"geolocation"});y(t.state),t.onchange=()=>{y(t.state)}}catch(t){console.log("Permission API not supported:",t),y("unknown")}}),M=()=>{if(!navigator.geolocation){P("Geolocation is not supported by your browser"),v(!1),C.error("Geolocation is not supported by your browser");return}if(v(!0),C.info("Getting your current location...",{autoClose:2e3}),!(window.isSecureContext||window.location.hostname==="localhost")){P("Location access requires HTTPS. Try accessing the site with https://"),v(!1),C.error("Location access requires HTTPS");return}navigator.geolocation.getCurrentPosition(n=>{const{latitude:c,longitude:d,accuracy:f}=n.coords;console.log("üìç Got location:",{latitude:c,longitude:d,accuracy:"".concat(f,"m")}),I([c,d]),w([c,d]),P(null),v(!1),C.success("Location updated! Accuracy: ".concat(f<100?"High":f<500?"Medium":"Low"," (").concat(Math.round(f),"m)"),{autoClose:3e3}),s(ne({radius:h,query:m,latitude:c,longitude:d}))},n=>{console.error("Geolocation error:",n);let c="Unable to get your location.",d="";switch(n.code){case n.PERMISSION_DENIED:c="Location permission denied.",d="Please check your browser settings and allow location access for this site.";break;case n.POSITION_UNAVAILABLE:c="Location information is unavailable.",d="Please check your GPS/location services are enabled.";break;case n.TIMEOUT:c="Location request timed out.",d="Please try again or check your internet connection.";break;default:d="Please try again or enter your zipcode manually."}P("".concat(c," ").concat(d)),v(!1),C.error(c,{autoClose:5e3}),r!=null&&r.latitude&&(r!=null&&r.longitude)&&setTimeout(()=>{I([r.latitude,r.longitude]),w([r.latitude,r.longitude]),C.info("Using your registered address instead.",{autoClose:3e3})},1e3)},{enableHighAccuracy:!1,timeout:15e3,maximumAge:3e5}),setTimeout(()=>{D&&(console.log("Trying high accuracy location..."),navigator.geolocation.getCurrentPosition(n=>{const{latitude:c,longitude:d,accuracy:f}=n.coords;console.log("üìç Got high accuracy location:",{latitude:c,longitude:d,accuracy:"".concat(f,"m")}),(!x||f<100)&&(I([c,d]),w([c,d]),P(null),C.success("High accuracy location updated! (¬±".concat(Math.round(f),"m)"),{autoClose:3e3}))},n=>{console.log("High accuracy location failed, using previous result")},{enableHighAccuracy:!0,timeout:1e4,maximumAge:6e4}))},3e3)},$=()=>{s(ne({radius:h,query:m,latitude:x?x[0]:r==null?void 0:r.latitude,longitude:x?x[1]:r==null?void 0:r.longitude})),C.info("Searching for listings within ".concat(h," miles..."))},W=t=>{p(t.target.value)},K=()=>{const n={21042:[39.2904,-76.8734],10001:[40.7506,-73.9971],90210:[34.1031,-118.4105],60601:[41.8856,-87.6228],33101:[25.7781,-80.1874]}[g];if(n)I(n),w(n),P(null),C.success("Location updated to zipcode ".concat(g));else{const c=[39.2904,-76.8734];I(c),w(c),C.info("Using default location for zipcode ".concat(g))}},de=t=>{u(parseInt(t.target.value))};return e.jsx(oe,{fluid:!0,className:"py-4",children:e.jsxs(V,{children:[e.jsxs(Y,{md:3,children:[e.jsx(b,{children:e.jsxs(b.Body,{children:[e.jsx("h5",{children:"Search Filters"}),e.jsxs(L.Group,{className:"mb-3",children:[e.jsxs(L.Label,{children:["Radius: ",e.jsxs("strong",{children:[h," miles"]})]}),e.jsx(L.Range,{min:"1",max:"50",value:h,onChange:de}),e.jsx(L.Text,{className:"text-muted",children:"Search radius from your location"})]}),e.jsxs(L.Group,{className:"mb-3",children:[e.jsx(L.Label,{children:"Search"}),e.jsx(L.Control,{type:"text",placeholder:"Search for items...",value:m,onChange:W,onKeyPress:t=>t.key==="Enter"&&$()}),e.jsx(L.Text,{className:"text-muted",children:"Search by item name, description, or category"})]}),e.jsxs(L.Group,{className:"mb-3",children:[e.jsx(L.Label,{children:"Update Location"}),x&&e.jsx("div",{className:"alert alert-info py-1 px-2 mb-2",children:e.jsxs("small",{children:["üìç Current: ",x[0].toFixed(4),", ",x[1].toFixed(4)]})}),e.jsx("div",{className:"d-flex gap-2 mb-2",children:e.jsx(E,{variant:j==="denied"?"outline-warning":"outline-secondary",size:"sm",onClick:M,className:"flex-fill",disabled:D||j==="unsupported",title:j==="denied"?"Location permission denied - click to try again":j==="granted"?"Location permission granted":j==="unsupported"?"Geolocation not supported by your browser":"Get your current location",children:D?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner-border spinner-border-sm me-2",role:"status","aria-hidden":"true"}),"Getting Location..."]}):e.jsxs(e.Fragment,{children:["üìç Use Current Location",j==="denied"&&" ‚ö†Ô∏è",j==="granted"&&" ‚úÖ",j==="unsupported"&&" ‚ùå"]})})}),j==="denied"&&e.jsx("div",{className:"alert alert-warning py-2 px-3 mb-2",children:e.jsxs("small",{children:[e.jsx("strong",{children:"Location Blocked:"})," Please enable location access in your browser settings, then refresh the page and try again."]})}),j==="unsupported"&&e.jsx("div",{className:"alert alert-info py-2 px-3 mb-2",children:e.jsxs("small",{children:[e.jsx("strong",{children:"Location Unavailable:"})," Your browser doesn't support location services. Please enter your zipcode below."]})}),e.jsx(L.Control,{type:"text",placeholder:"Or enter zipcode",value:g,onChange:t=>U(t.target.value),onKeyPress:t=>{t.key==="Enter"&&K()}}),e.jsx(E,{variant:"outline-primary",size:"sm",onClick:K,className:"w-100 mt-2",disabled:!g,children:"Update by Zipcode"}),T&&e.jsx(L.Text,{className:"text-warning d-block mt-2",children:T})]}),e.jsx(E,{variant:"primary",onClick:$,disabled:i,className:"w-100",children:i?"Searching...":"Search Listings"}),a.length>0&&e.jsx("div",{className:"mt-3",children:e.jsxs("small",{className:"text-muted",children:["Found ",a.length," listings"]})})]})}),e.jsx(b,{className:"mt-3",children:e.jsxs(b.Body,{children:[e.jsx("h6",{children:"Nearby Listings"}),a.slice(0,5).map(t=>{var n;return e.jsxs("div",{className:"mb-2 p-2 border-bottom listing-item",style:{cursor:"pointer",transition:"background-color 0.2s"},onClick:()=>o("/listings/".concat(t.$id||t.id)),onMouseEnter:c=>c.currentTarget.style.backgroundColor="#f8f9fa",onMouseLeave:c=>c.currentTarget.style.backgroundColor="transparent",children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-start",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"text-primary",style:{cursor:"pointer"},onClick:c=>{var d;c.stopPropagation(),(d=t.user)!=null&&d.id&&o("/users/".concat(t.user.id))},children:t.title}),e.jsx("br",{}),e.jsx("small",{className:"text-muted text-primary",style:{cursor:"pointer"},onClick:c=>{var d;c.stopPropagation(),(d=t.user)!=null&&d.id&&o("/users/".concat(t.user.id))},children:((n=t.user)==null?void 0:n.username)||"Unknown User"})]}),e.jsx(Q,{bg:"secondary",children:e.jsx(q,{listing:t,cityCache:A,setCityCache:_})})]}),e.jsx("small",{children:t.category})]},t.$id||t.id)})]})})]}),e.jsxs(Y,{md:9,children:[e.jsx(b,{className:"map-container",children:e.jsx(b.Body,{className:"p-0",children:e.jsxs(be,{center:k,zoom:11,style:{height:"400px",width:"100%"},className:"map-view",onMapReady:()=>console.log("üó∫Ô∏è Map loaded successfully"),children:[x&&e.jsxs(e.Fragment,{children:[e.jsx(ce,{position:x,children:e.jsxs(le,{children:[e.jsx("strong",{children:"Your Location"}),T&&e.jsx("br",{}),T&&e.jsx("small",{className:"text-muted",children:"Using registered address"})]})}),e.jsx(Le,{center:x,radius:h*1609.34,fillColor:"blue",fillOpacity:.1,color:"blue"})]}),a.map(t=>{var n,c,d;return!((n=t.user)!=null&&n.latitude)||!((c=t.user)!=null&&c.longitude)?null:e.jsx(ce,{position:[t.user.latitude,t.user.longitude],children:e.jsxs(le,{children:[e.jsx("strong",{style:{cursor:"pointer"},onClick:()=>{var f;return((f=t.user)==null?void 0:f.id)&&o("/users/".concat(t.user.id))},children:t.title}),e.jsx("br",{}),t.category,e.jsx("br",{}),e.jsxs("small",{children:["By:",e.jsx("span",{className:"text-primary",style:{cursor:"pointer"},onClick:f=>{var J;f.stopPropagation(),(J=t.user)!=null&&J.id&&o("/users/".concat(t.user.id))},children:((d=t.user)==null?void 0:d.username)||"Unknown User"})]}),e.jsx("br",{}),e.jsxs("small",{children:[e.jsx(q,{listing:t,cityCache:A,setCityCache:_})," away"]}),e.jsx("br",{}),e.jsx(E,{variant:"primary",size:"sm",className:"mt-2",onClick:()=>o("/listings/".concat(t.$id||t.id)),children:"View Listing"})]})},t.$id||t.id)})]},"".concat(k[0],"-").concat(k[1]))})}),a.length>0&&e.jsx(b,{className:"mt-3",children:e.jsxs(b.Body,{children:[e.jsxs("h5",{children:["All Search Results (",a.length," items)"]}),e.jsx("div",{style:{maxHeight:"400px",overflowY:"auto"},children:e.jsx(V,{children:a.map(t=>e.jsx(Y,{xs:12,sm:6,md:4,className:"mb-3",children:e.jsx(b,{className:"h-100 listing-card",style:{cursor:"pointer"},onClick:()=>o("/listings/".concat(t.$id||t.id)),onMouseEnter:n=>n.currentTarget.style.transform="translateY(-2px)",onMouseLeave:n=>n.currentTarget.style.transform="translateY(0)",children:e.jsxs(b.Body,{children:[e.jsx("h6",{className:"text-primary",style:{cursor:"pointer"},onClick:n=>{n.stopPropagation(),o("/users/".concat(t.user.id))},children:t.title}),e.jsx("p",{className:"small mb-1",children:t.category}),e.jsxs("p",{className:"small text-muted mb-2",children:["By:",e.jsx("span",{className:"text-primary",style:{cursor:"pointer"},onClick:n=>{n.stopPropagation(),o("/users/".concat(t.user.id))},children:t.user.username})]}),e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx(Q,{bg:"info",children:t.condition}),e.jsx(Q,{bg:"secondary",children:e.jsx(q,{listing:t,cityCache:A,setCityCache:_})})]})]})})},t.$id||t.id))})})]})})]})]})})};export{Se as default};
